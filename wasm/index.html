<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DRESS — Interactive Edge Similarity</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; color: #333; padding: 2rem; }
  h1 { margin-bottom: 0.5rem; }
  .subtitle { color: #666; margin-bottom: 1.5rem; }
  .container { max-width: 900px; margin: 0 auto; }
  .panel { background: #fff; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
  label { font-weight: 600; display: block; margin-bottom: 0.3rem; }
  textarea { width: 100%; height: 140px; font-family: 'Courier New', monospace; font-size: 14px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
  .row { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.8rem; }
  .field { flex: 1; min-width: 140px; }
  .field input, .field select { width: 100%; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; }
  button { background: #2563eb; color: #fff; border: none; padding: 0.6rem 1.5rem; border-radius: 4px; font-size: 1rem; cursor: pointer; margin-top: 1rem; }
  button:hover { background: #1d4ed8; }
  button:disabled { background: #94a3b8; cursor: not-allowed; }
  #status { margin-top: 0.8rem; font-style: italic; color: #666; }
  #results { white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px; max-height: 400px; overflow-y: auto; }
  table { border-collapse: collapse; width: 100%; font-size: 13px; font-family: 'Courier New', monospace; }
  th, td { border: 1px solid #ddd; padding: 4px 8px; text-align: right; }
  th { background: #f0f0f0; }
  .summary { display: flex; gap: 2rem; margin-bottom: 1rem; }
  .summary .stat { }
  .summary .stat .val { font-size: 1.5rem; font-weight: 700; color: #2563eb; }
  .summary .stat .lbl { font-size: 0.8rem; color: #888; }
</style>
</head>
<body>
<div class="container">
  <h1>DRESS</h1>
  <p class="subtitle">Dynamic Structural Similarity — WebAssembly Demo</p>

  <div class="panel">
    <label for="edges">Edge list (one edge per line: <code>u v [weight]</code>)</label>
    <textarea id="edges" spellcheck="false">0 1
1 2
2 3
0 2
0 3
1 3</textarea>

    <div class="row">
      <div class="field">
        <label for="numVertices">Vertices (0 = auto)</label>
        <input id="numVertices" type="number" value="0" min="0">
      </div>
      <div class="field">
        <label for="variant">Variant</label>
        <select id="variant">
          <option value="0" selected>Undirected</option>
          <option value="1">Directed</option>
          <option value="2">Forward</option>
          <option value="3">Backward</option>
        </select>
      </div>
      <div class="field">
        <label for="maxIter">Max iterations</label>
        <input id="maxIter" type="number" value="100" min="1">
      </div>
      <div class="field">
        <label for="epsilon">Epsilon</label>
        <input id="epsilon" type="text" value="1e-6">
      </div>
      <div class="field">
        <label for="weighted">Weighted</label>
        <select id="weighted">
          <option value="0" selected>No</option>
          <option value="1">Yes</option>
        </select>
      </div>
    </div>

    <button id="runBtn" disabled>Loading WASM…</button>
    <div id="status"></div>
  </div>

  <div class="panel" id="outputPanel" style="display:none">
    <div class="summary" id="summary"></div>
    <div id="results"></div>
  </div>
</div>

<!-- Load Emscripten glue (must be built first: bash build.sh) -->
<script src="dress_wasm.js"></script>
<script type="module">
import { dressFit, Variant } from './dress.js';

const runBtn     = document.getElementById('runBtn');
const statusEl   = document.getElementById('status');
const outputPanel = document.getElementById('outputPanel');
const summaryEl  = document.getElementById('summary');
const resultsEl  = document.getElementById('results');

// Wait for WASM to be ready
try {
    // Trigger module load
    await dressFit({ numVertices: 2, sources: [0], targets: [1], maxIterations: 1 });
    runBtn.disabled = false;
    runBtn.textContent = 'Run DRESS';
    statusEl.textContent = 'WASM module loaded.';
} catch (e) {
    statusEl.textContent = 'Failed to load WASM: ' + e.message;
}

runBtn.addEventListener('click', async () => {
    runBtn.disabled = true;
    statusEl.textContent = 'Running…';
    outputPanel.style.display = 'none';

    try {
        const text       = document.getElementById('edges').value;
        const nv         = parseInt(document.getElementById('numVertices').value) || undefined;
        const variant    = parseInt(document.getElementById('variant').value);
        const maxIter    = parseInt(document.getElementById('maxIter').value);
        const epsilon    = parseFloat(document.getElementById('epsilon').value);
        const weighted   = document.getElementById('weighted').value === '1';

        // Parse edge list text
        const sources = [];
        const targets = [];
        const weights = [];
        for (const line of text.split('\n')) {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith('#')) continue;
            const parts = trimmed.split(/\s+/);
            if (parts.length < 2) continue;
            sources.push(parseInt(parts[0], 10));
            targets.push(parseInt(parts[1], 10));
            if (weighted && parts.length >= 3) {
                weights.push(parseFloat(parts[2]));
            }
        }
        const N = (nv && nv > 0) ? nv : (Math.max(...sources, ...targets) + 1);

        const t0 = performance.now();
        const r = await dressFit({
            numVertices: N,
            sources:     new Int32Array(sources),
            targets:     new Int32Array(targets),
            weights:     weighted ? new Float64Array(weights) : null,
            variant,
            maxIterations: maxIter,
            epsilon,
        });
        const elapsed = ((performance.now() - t0) / 1000).toFixed(4);

        // Summary
        summaryEl.innerHTML = `
            <div class="stat"><div class="val">${r.sources.length}</div><div class="lbl">Edges</div></div>
            <div class="stat"><div class="val">${r.nodeDress.length}</div><div class="lbl">Vertices</div></div>
            <div class="stat"><div class="val">${r.iterations}</div><div class="lbl">Iterations</div></div>
            <div class="stat"><div class="val">${r.delta.toExponential(3)}</div><div class="lbl">Delta</div></div>
            <div class="stat"><div class="val">${elapsed}s</div><div class="lbl">Time</div></div>
        `;

        // Edge table
        let html = '<table><tr><th>Edge</th><th>Source</th><th>Target</th><th>Weight</th><th>DRESS</th></tr>';
        for (let i = 0; i < r.sources.length; i++) {
            html += `<tr>
                <td>${i}</td>
                <td>${r.sources[i]}</td>
                <td>${r.targets[i]}</td>
                <td>${r.edgeWeight[i].toFixed(4)}</td>
                <td>${r.edgeDress[i].toFixed(6)}</td>
            </tr>`;
        }
        html += '</table>';

        // Node table
        html += '<br><table><tr><th>Node</th><th>Node DRESS</th></tr>';
        for (let i = 0; i < r.nodeDress.length; i++) {
            html += `<tr><td>${i}</td><td>${r.nodeDress[i].toFixed(6)}</td></tr>`;
        }
        html += '</table>';

        resultsEl.innerHTML = html;
        outputPanel.style.display = 'block';
        statusEl.textContent = `Done in ${elapsed}s.`;
    } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
        console.error(e);
    } finally {
        runBtn.disabled = false;
    }
});
</script>
</body>
</html>
